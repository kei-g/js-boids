"use strict";var __extends=this&&this.__extends||function(){var o=function(t,e){return(o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])})(t,e)};return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}(),__read=this&&this.__read||function(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var o,n,r=i.call(t),s=[];try{for(;(void 0===e||0<e--)&&!(o=r.next()).done;)s.push(o.value)}catch(t){n={error:t}}finally{try{o&&!o.done&&(i=r.return)&&i.call(r)}finally{if(n)throw n.error}}return s},__values=this&&this.__values||function(t){var e="function"==typeof Symbol&&Symbol.iterator,i=e&&t[e],o=0;if(i)return i.call(t);if(t&&"number"==typeof t.length)return{next:function(){return{value:(t=t&&o>=t.length?void 0:t)&&t[o++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")},Vector2D=function(){function i(t,e){"number"==typeof t?(this.x=t,this.y=e):(this.x=t.x,this.y=null!==(t=null==t?void 0:t.y)&&void 0!==t?t:e)}return i.prototype.add=function(t){this.x+=t.x,this.y+=t.y},i.prototype.added=function(t){return new i(this.x+t.x,this.y+t.y)},Object.defineProperty(i.prototype,"collisionDetector",{get:function(){var e=this;return function(t){return t.doesCollide(e)}},enumerable:!1,configurable:!0}),i.prototype.copyTo=function(t){t.x=this.x,t.y=this.y},i.prototype.crossProduct=function(t){return this.x*t.y-this.y*t.x},i.prototype.divide=function(t){this.x/=t,this.y/=t},i.prototype.dividedBy=function(t){return new i(this.x/t,this.y/t)},i.prototype.dotProduct=function(t){return this.x*t.x+this.y*t.y},i.prototype.from=function(t){return new i(this.x-t.x,this.y-t.y)},Object.defineProperty(i.prototype,"length",{get:function(){return Math.hypot(this.x,this.y)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"squareOfLength",{get:function(){return this.dotProduct(this)},enumerable:!1,configurable:!0}),Object.defineProperty(i.prototype,"retrorse",{get:function(){return new i(-this.x,-this.y)},enumerable:!1,configurable:!0}),i.prototype.rotate=function(t){var e=__read([Math.cos(t),Math.sin(t),this.x,this.y],4),i=e[0],o=e[1],t=e[2],e=e[3];this.x=t*i-e*o,this.y=t*o+e*i},i.prototype.rotatedBy=function(t){var e=__read([Math.cos(t),Math.sin(t)],2),t=e[0],e=e[1];return new i(this.x*t-this.y*e,this.x*e+this.y*t)},i.prototype.scale=function(t){this.x*=t,this.y*=t},i.prototype.scaledBy=function(t){return new i(this.x*t,this.y*t)},i.prototype.sub=function(t){this.x-=t.x,this.y-=t.y},i}(),Acceleration=function(e){function t(){var t=e.call(this,0,0)||this;return t.count=0,t}return __extends(t,e),t.prototype.add=function(t){e.prototype.add.call(this,t),this.count++},t.prototype.effectTo=function(t){this.count&&t.add(this.dividedBy(this.count))},t}(Vector2D),Deceleration=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.add=function(t){e.prototype.sub.call(this,t),this.count++},t}(Acceleration),AvoidanceDeceleration=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.match=function(t){var e=t.distance<12;return e&&this.add(t.vector.dividedBy(4*t.distance)),e},e}(Deceleration),FarAcceleration=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return __extends(e,t),e.prototype.match=function(t){for(var e=t.distance,i=0;i<4;i++)if(e<48+24*i)return this.add(t.vector.dividedBy(e*(i+1)*8)),!0},e}(Acceleration),SpreadAcceleration=function(i){function t(t){var e=i.call(this)||this;return e.spread=t,e}return __extends(t,i),t.prototype.match=function(t){var e=t.distance<this.spread;return e&&(t=t.relationalBoid,this.add(t.velocity.dividedBy(32*t.speed))),e},t}(Acceleration),Boid=function(){function t(t,e,i,o,n){this.all=t,this.canvas=e,this.circles=i,this.context=o,this.index=n;do{var r=20+Math.random()*(e.width-40),s=20+Math.random()*(e.height-40)}while(this.position=new Vector2D(r,s),i.some(this.position.collisionDetector));this.velocity=new Vector2D(1-2*Math.random(),1-2*Math.random())}return t.prototype.avoidCircles=function(){var e,t,i;try{for(var o=__values(this.circles.filter(this.position.collisionDetector)),n=o.next();!n.done;n=o.next()){var r=n.value;this.position.sub(this.velocity);var s=r.intersectingPoint(this);null!==(i=null==s?void 0:s.rotate(this))&&void 0!==i||(this.position.from(r.center).copyTo(this.velocity),this.normalize()),this.position.add(this.velocity)}}catch(t){e={error:t}}finally{try{n&&!n.done&&(t=o.return)&&t.call(o)}finally{if(e)throw e.error}}},t.prototype.draw=function(){this.context.beginPath(),this.context.fillStyle="rgb(255, 128, 0)",this.context.arc(this.position.x,this.position.y,1,0,2*Math.PI,!0),this.context.fill()},t.prototype.drawCanvas=function(){this.context.fillStyle="rgba(0, 0, 0, .1)",this.context.fillRect(0,0,this.canvas.width,this.canvas.height)},t.prototype.drawCircles=function(){this.circles.forEach(function(t){return t.draw()})},Object.defineProperty(t.prototype,"globalCompositeOperation",{set:function(t){this.context.globalCompositeOperation=t},enumerable:!1,configurable:!0}),t.prototype.move=function(){this.position.add(this.velocity),this.avoidCircles(),this.turnOverByEdgeOfCanvas()},Object.defineProperty(t.prototype,"nextPoint",{get:function(){return this.position.added(this.velocity)},enumerable:!1,configurable:!0}),t.prototype.normalize=function(){var t=.8+1.2*Math.random(),e=this.speed;t<e&&this.velocity.scale(t/e)},Object.defineProperty(t.prototype,"others",{get:function(){var i=this;return this.all.filter(function(t,e){return e!=i.index})},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"speed",{get:function(){return this.velocity.length},enumerable:!1,configurable:!0}),t.prototype.turnOverByEdgeOfCanvas=function(){this.position.x<0&&(this.position.x=0,this.velocity.x=Math.abs(this.velocity.x)),this.canvas.width<this.position.x&&(this.position.x=this.canvas.width,this.velocity.x=-Math.abs(this.velocity.x)),this.position.y<0&&(this.position.y=0,this.velocity.y=Math.abs(this.velocity.y)),this.canvas.height<this.position.y&&(this.position.y=this.canvas.height,this.velocity.y=-Math.abs(this.velocity.y))},t.prototype.update=function(){var e,t,i,o,n=[new AvoidanceDeceleration,new SpreadAcceleration(16+8*Math.random()),new FarAcceleration],r=this;try{for(var s=__values(this.others),a=s.next();!a.done;a=s.next())!function(t){var e=new BoidRelationship(r,t);n.find(function(t){return t.match(e)})}(a.value)}catch(t){e={error:t}}finally{try{a&&!a.done&&(t=s.return)&&t.call(s)}finally{if(e)throw e.error}}try{for(var c=__values(n),h=c.next();!h.done;h=c.next())h.value.effectTo(this.velocity)}catch(t){i={error:t}}finally{try{h&&!h.done&&(o=c.return)&&o.call(c)}finally{if(i)throw i.error}}},t}(),BoidRelationship=function(t,e){this.baseBoid=t,this.relationalBoid=e,this.vector=e.position.from(t.position),this.distance=this.vector.length};function within(e,i){return function(t){return e<=t&&t<=i}}var Circle=function(){function t(t,e,i,o,n){void 0===o&&(o=100),void 0===n&&(n="rgba(32, 32, 48, .5)"),this.context=t,this.radius=o,this.color=n,this.center=new Vector2D(e,i)}return t.prototype.amplitude=function(t,e){var i=e.position.added(e.velocity.scaledBy(t)),t=__read([e.nextPoint,this.center].map(function(t){return t.from(i)}),2),e=t[0],t=t[1];return Math.acos(e.dotProduct(t)/(e.length*t.length))},t.prototype.draw=function(){this.context.beginPath(),this.context.fillStyle=this.color,this.context.arc(this.center.x,this.center.y,this.radius,0,2*Math.PI,!0),this.context.fill()},t.prototype.doesCollide=function(t){return this.center.from(t).length<=this.radius},t.prototype.intersectingPoint=function(t){var e=t.position.from(this.center),i=t.velocity.squareOfLength,o=-t.velocity.dotProduct(e),e=o*o-i*(e.squareOfLength-this.squareOfRadius);if(0<=e){e=Math.sqrt(e),i=[(o+e)/i,(o-e)/i];if(i.some(within(0,1)))return new IntersectingPoint(this.amplitude(i[0],t))}},Object.defineProperty(t.prototype,"squareOfRadius",{get:function(){return this.radius*this.radius},enumerable:!1,configurable:!0}),t}(),IntersectingPoint=function(){function t(t){this.rotation=Math.PI-(2*t<=Math.PI?2:1)*t}return t.prototype.rotate=function(t){return t.velocity.rotate(this.rotation),!0},t}();function addOrRemoveCircle(t,e,i){var o,n,r=i.target.getBoundingClientRect(),i=new Vector2D(i.clientX,i.clientY).from(new Vector2D(r.left,r.top)),r=t.filter(i.collisionDetector);try{for(var s=__values(r),a=s.next();!a.done;a=s.next()){var c=a.value,h=t.indexOf(c);t.splice(h,1)}}catch(t){o={error:t}}finally{try{a&&!a.done&&(n=s.return)&&n.call(s)}finally{if(o)throw o.error}}0==r.length&&t.push(new Circle(e,i.x,i.y))}function updateBoids(t){var e,i,o,n,r=t[0];r.globalCompositeOperation="source-over",r.drawCanvas(),r.drawCircles(),r.globalCompositeOperation="lighter";try{for(var s=__values(t),a=s.next();!a.done;a=s.next()){var c=a.value;c.draw(),c.update()}}catch(t){e={error:t}}finally{try{a&&!a.done&&(i=s.return)&&i.call(s)}finally{if(e)throw e.error}}try{for(var h=__values(t),l=h.next();!l.done;l=h.next()){var u=l.value;u.normalize(),u.move()}}catch(t){o={error:t}}finally{try{l&&!l.done&&(n=h.return)&&n.call(h)}finally{if(o)throw o.error}}}function generateBoids(t){for(var e=document.getElementById(t.id),i=e.getContext("2d"),o=[],n=0;n<1;n++){var r=100+Math.random()*(e.width-200),s=100+Math.random()*(e.height-200);o.push(new Circle(i,r,s))}for(var a=[],n=0;n<t.num;n++)a.push(new Boid(a,e,o,i,n));return e.onmouseup=function(t){return addOrRemoveCircle(o,i,t)},{boids:a,update:updateBoids}}
