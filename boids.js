var x=(i,t,e)=>{if(!t.has(i))throw TypeError("Cannot "+e)};var f=(i,t,e)=>(x(i,t,"read from private field"),e?e.call(i):t.get(i)),b=(i,t,e)=>{if(t.has(i))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(i):t.set(i,e)},B=(i,t,e,o)=>(x(i,t,"write to private field"),o?o.call(i,e):t.set(i,e),e);var u,v;class a{constructor(t,e){typeof t=="number"?(this.x=t,this.y=e):(this.x=t.x,this.y=t?.y??e)}add(t){this.x+=t.x,this.y+=t.y}added(t){return new a(this.x+t.x,this.y+t.y)}get collisionDetector(){return t=>t.doesCollide(this)}copyTo(t){t.x=this.x,t.y=this.y}crossProduct(t){return this.x*t.y-this.y*t.x}divide(t){this.x/=t,this.y/=t}dividedBy(t){return new a(this.x/t,this.y/t)}dotProduct(t){return this.x*t.x+this.y*t.y}from(t){return new a(this.x-t.x,this.y-t.y)}get length(){return Math.hypot(this.x,this.y)}get squareOfLength(){return this.dotProduct(this)}get retrorse(){return new a(-this.x,-this.y)}rotate(t){const[e,o,n,r]=[Math.cos(t),Math.sin(t),this.x,this.y];this.x=n*e-r*o,this.y=n*o+r*e}rotatedBy(t){const[e,o]=[Math.cos(t),Math.sin(t)];return new a(this.x*e-this.y*o,this.x*o+this.y*e)}scale(t){this.x*=t,this.y*=t}scaledBy(t){return new a(this.x*t,this.y*t)}sub(t){this.x-=t.x,this.y-=t.y}}class g extends a{constructor(){super(0,0);b(this,u,[]);this.count=0}add(e,o){e instanceof y?(super.add(this.resolve(e,o)),f(this,u).push(e),this.count++):super.add(e)}effectTo(e){this.count&&e.add(this.dividedBy(this.count))}get matched(){return f(this,u)}sub(e,o){e instanceof y?(super.sub(this.resolve(e,o)),f(this,u).push(e),this.count++):super.sub(e)}}u=new WeakMap;class D extends g{add(t,e){t instanceof y?super.sub(t,e):super.sub(t)}}class C extends D{match(t){const e=t.distance<12;return e&&this.add(t),e}resolve(t){return t.vector.dividedBy(t.distance*4)}}class w extends g{match(t){const e=t.distance;for(let o=0;o<4;o++)if(e<48+o*24)return this.add(t,o),!0}resolve(t,e){return t.vector.dividedBy(t.distance*(e+1)*8)}}class L extends g{constructor(e){super();this.spread=e}match(e){const o=e.distance<this.spread;return o&&this.add(e),o}resolve(e){const o=e.relationalBoid;return o.velocity.dividedBy(o.speed*32)}}const l=class l{constructor(t){b(this,v,void 0);this.backup=new a(0,0);this.degrees={suffocation:0};B(this,v,new WeakRef(t)),this.canvas=t.canvas,this.context=t.context;do{const e=20+Math.random()*(t.canvas.width-40),o=20+Math.random()*(t.canvas.height-40);this.position=new a(e,o)}while(l.circles.some(this.position.collisionDetector));this.velocity=new a(1-Math.random()*2,1-Math.random()*2)}avoidCircles(){for(const t of l.circles.filter(this.position.collisionDetector))this.position.sub(this.velocity),t.intersectingPoint(this)?.rotate(this)??(this.position.from(t.center).copyTo(this.velocity),this.normalize()),this.position.add(this.velocity)}get color(){return[this.colorForRed,this.colorForGreen,this.colorForBlue].join(",")}get colorForBlue(){return 0}get colorForGreen(){return Math.min(Math.max(0,255-this.degrees.suffocation**1.125),128)}get colorForRed(){return 255}draw(){this.context.beginPath(),this.context.fillStyle=`rgb(${this.color})`,this.context.arc(this.position.x,this.position.y,1,0,Math.PI*2,!0),this.context.fill(),this.context.closePath()}get isSuffocating(){return 0<this.degrees.suffocation}move(){this.nextPoint.copyTo(this.position),this.avoidCircles(),this.turnOverByEdgeOfCanvas(),this.updateSuffocation()}get nextPoint(){return this.position.added(this.nextVelocity)}get nextVelocity(){return this.velocity.added(this.backup).dividedBy(2)}normalize(){const t=.8+Math.random()*1.2,e=this.speed;t<e&&this.velocity.scale(t/e)}get others(){return l.all.filter(t=>t!==this)}get session(){return f(this,v).deref()}get speed(){return this.velocity.length}turnOverByEdgeOfCanvas(){this.position.x<0&&(this.position.x=0,this.velocity.x=Math.abs(this.velocity.x)),this.canvas.width<this.position.x&&(this.position.x=this.canvas.width,this.velocity.x=-Math.abs(this.velocity.x)),this.position.y<0&&(this.position.y=0,this.velocity.y=Math.abs(this.velocity.y)),this.canvas.height<this.position.y&&(this.position.y=this.canvas.height,this.velocity.y=-Math.abs(this.velocity.y))}update(){this.velocity.copyTo(this.backup);const t=new C,e=[t,new L(16+Math.random()*8),new w];for(const n of this.others){const r=new y(this,n);e.find(s=>s.match(r))}const o={suffocation:0};for(const n of t.matched)o.suffocation=.03125,n.relationalBoid.degrees.suffocation+=.03125;this.degrees.suffocation+=o.suffocation;for(const n of e)n.effectTo(this.velocity)}updateSuffocation(){this.degrees.suffocation+=[-.125,1][+l.circles.some(t=>t.doesCollide(this.position))],this.degrees.suffocation=Math.max(0,this.degrees.suffocation)}};v=new WeakMap,l.all=[],l.circles=[];let c=l;class R extends c{constructor(t){super(t)}get colorForBlue(){return Math.min(Math.max(0,255-this.degrees.suffocation**1.125),255)}get colorForGreen(){return Math.min(Math.max(0,255-this.degrees.suffocation**1.125),128)}get colorForRed(){return Math.max(0,Math.min(this.degrees.suffocation*255/128,255))}}class y{constructor(t,e){this.relationalBoid=e;this.vector=e.position.from(t.position),this.distance=this.vector.length}}class V{constructor(t,e,o,n=100,r="rgba(32, 32, 48, .5)"){this.context=t;this.radius=n;this.color=r;this.center=new a(e,o)}amplitude(t,e){const o=e.position.added(e.velocity.scaledBy(t)),[n,r]=[e.nextPoint,this.center].map(s=>s.from(o));return Math.acos(n.dotProduct(r)/(n.length*r.length))}draw(){this.context.beginPath(),this.context.fillStyle=this.color,this.context.arc(this.center.x,this.center.y,this.radius,0,Math.PI*2,!0),this.context.fill()}doesCollide(t){return this.center.from(t).length<=this.radius}intersectingPoint(t){const e=t.position.from(this.center),o=t.velocity.squareOfLength,n=-t.velocity.dotProduct(e),r=e.squareOfLength-this.squareOfRadius,s=n*n-o*r;if(0<=s){const d=Math.sqrt(s),h=[(n+d)/o,(n-d)/o];if(h.some(H(0,1)))return new T(this.amplitude(h[0],t))}}get squareOfRadius(){return this.radius*this.radius}}class T{constructor(t){this.rotation=Math.PI-(t*2<=Math.PI?2:1)*t}rotate(t){return t.velocity.rotate(this.rotation),!0}}const k=(i,t)=>{const e=t.target,o=e.getBoundingClientRect(),n=new a(t.x,t.y).from(new a(o.left,o.top)),{x:r}=n.scaledBy(e.width/o.width),{y:s}=n.scaledBy(e.height/o.height),d=new a(r,s),h=c.circles.filter(d.collisionDetector);for(const m of h){const p=c.circles.indexOf(m);c.circles.splice(p,1)}h.length==0&&c.circles.push(new V(i,d.x,d.y))},S=i=>[...i].some(t=>t.isSuffocating),I=(i,t,e,o)=>isNaN(i)?o:Math.max(t,Math.min(i,e)),M=()=>{c.all.splice(0);const i=document.getElementById("boids"),t=i.getContext("2d"),e=()=>F(i,t),o=document.getElementById("number-of-boids"),n=document.getElementById("max-number-of-boids"),r=I(parseInt(o.value),1,parseInt(n.value),100),s={canvas:i,context:t,numberOfBoids:r};o.value=r.toString();for(let d=0;d<r;d++){const h=Math.floor(Math.random()*2),m=[c,R][h];c.all.push(new m(s))}return s.intervalId=setInterval(e,25),s.regenerate=d=>(clearInterval(d.intervalId),M()),s},E=()=>{const i=()=>(t.height=t.clientHeight,t.width=t.clientWidth,void 0),t=document.getElementById("boids");window.addEventListener("resize",i),i(),t.onmouseup=s=>k(e,s);const e=t.getContext("2d"),o={session:M()},n=()=>(o.session=o.session.regenerate(o.session),void 0);document.getElementById("reset-button").addEventListener("click",n)},P=()=>{for(const i of c.all){const{session:t}=i;if(t)return t}},O=i=>t=>{const e={count:0,sum:0};for(const o of i)e.sum+=t(o);return e},F=(i,t)=>{t.globalCompositeOperation="source-over",t.fillStyle="rgba(0, 0, 0, .1)",t.fillRect(0,0,i.width,i.height),c.circles.forEach(s=>s.draw()),t.globalCompositeOperation="lighter";const e=new Set;for(const s of c.all)s.draw(),s.update(),s.degrees.suffocation<128&&e.add(s);const o=document.getElementById("number-of-living-boids"),n=document.getElementById("health-of-living-boids"),r=P();if(r){const s=r.numberOfBoids,d=Math.floor(e.size*3/s),h=["bad","not-good","good","perfect"][d];o.setAttribute("face",[h,"warn"][+(1<d&&S(e))]),o.setAttribute("status",h),o.textContent=e.size.toString();const{sum:m}=O(e)(p=>128-p.degrees.suffocation);n.textContent="\u{1F31F}"+Math.floor(m*9999/(s*128))}else o.removeAttribute("face"),o.removeAttribute("status"),o.textContent="",n.textContent="";c.all.splice(0),c.all.push(...e);for(const s of c.all)s.normalize(),s.move()},H=(i,t)=>e=>i<=e&&e<=t;window.addEventListener("DOMContentLoaded",E);
